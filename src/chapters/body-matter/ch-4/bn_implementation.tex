%!TEX root = ../../../tugas-akhir.tex
\section{Implementasi Algoritma Paralel pada Library big integer}
  \subsection{Lingkungan Implementasi} \label{sec:impl_env}
    Sesuai dengan pertimbangan pada subbab \ref{sec:parallel_env}, implementasi algoritma paralel akan dilakukan dengan menggunakan pthread. Implementasi akan dilakukan menggunakan \textit{compiler} GCC versi 5.4.0 dan dijalankan pada sistem operasi Ubuntu 18.04 64-bit. Penggunaan TLS akan diuji pada penggunaan HTTPS pada web server yang diinstall pada sistem operasi. Web server yang digunakan adalah Apache2 dengan menggunakan modul tambahan mod\_ssl. Arsitektur sistem yang digunakan dapat dilihat pada Gambar \ref{fig:openssl_arch}

    \begin{figure}[h]
      \centering
      \includegraphics[width=0.4\textwidth]{resources/img/ch-4/implementation_arch.png}
      \caption{Arsitektur OpenSSL}
      \label{fig:openssl_arch}
    \end{figure}

    % Cek lagi jumlahnya
    Secara default, jumlah maksimal thread maksimum yang akan digunakan oleh OpenSSL untuk menjalankan komputasi big integer secara paralel akan bergantung pada jumlah core yang terdapat pada lingkungan instalasi. Dalam aplikasi yang membutuhkan komputasi yang tinggi setiap thread akan berjalan secara terus menerus. Dengan demikian jumlah thread maksimum akan sama dengan jumlah aplikasi. Namun, aplikasi juga memiliki pilihan konfigurasi untuk menentukan jumlah thread maksimum yang dapat digunakan.
    % \todo{cite disini}

  \subsection{Batasan Implementasi}
    Implementasi dilakukan pada sistem operasi Ubuntu 64 bit. Karena itu, implementasi library big number hanya berfokus pada openssl dengan yang memiliki konfigurasi makro sebagai berikut:

    \begin{enumerate}[label=\roman*.]
      \item BN\_ULONG = unsigned long
      \item OPENSSL\_SMALL\_FOOTPRINT = false
      \item BN\_MUL\_COMBA = true
      \item BN\_RECURSION = true
      \item BN\_CTX\_POOL\_SIZE = 16
    \end{enumerate}
    % \todo{masukin lampiran?}
    Konfigurasi makro tersebut digunakan dalam pemilihan dan manajemen struktur data yang digunakan serta pemilihan algoritma pada bagian tertentu. Sebagai contoh, algoritma yang digunakan dalam perkalian adalah algoritma karatsuba dan algoritma comba pada basis rekursif.


  \subsection{Struktur File \textit{Source Code}}

    \begin{figure}[h]
      \centering
      \includegraphics[width=0.8\textwidth]{resources/img/ch-4/file-tree.png}
      \caption{Struktur Source Code OpenSSL}
      \label{fig:ossl_file_structure}
    \end{figure}

    Struktur \textit{source code} dapat dilihat pada Gambar \ref{fig:ossl_file_structure}. Direktori utama berisi pembagian dari fungsi aplikasi yang ada dalam OpenSSL. Beberapa fungsi tersebut adalah direktori |doc| yang berisi dokumentasi OpenSSL, |crypto| yang berisi library kriptografi, |ssl| yang berisi dari library komunikasi ssl, serta |test| yang berisi unit test yang dimiliki OpenSSL.

    Direktori |crypto| berisi modul-modul yang membentuk libcrypto, dengan setiap modul terbentuk dalam sebuah direktori yang berbeda. Modul |bn| merupakan modul yang mengatasi perhitungan operasi aritmatika big integer. Selain itu, modul |dh| dan |rsa| merupakan modul yang menangani komputasi Diffie-Hellman dan RSA pada OpenSSL.

    Modul |bn| memiliki beberapa submodul masing-masing merupakan file yang berbeda. Setiap submodul sendiri mengatasi fungsi yang terkait dengan submodul tersebut, ataupun operasi yang komputasinya mirip dengan submodul. Sebagai contoh, submodul |bn_add| merupakan submodul yang mengatasi operasi penjumlahan dan pengurangan pada big integer. Selain itu, submodul |bn_mul| merupakan submodul yang mengatasi operasi perkalian serta pemilihan algoritma perkalian yang digunakan dalam OpenSSL.

    Direktori |test| dan |util| merupakan direktori yang digunakan dalam \textit{unit test} OpenSSL. Dalam direktori ini terdapat kasus uji dan script yang digunakan dalam unit test untuk setiap modul untuk melakukan test terhadap fungsionalitas OpenSSL. Penjelasan lebih jauh terhadap pengujian fungsionalitas OpenSSL dapat dilihat pada subbab \ref{sec:func_testing}

  \subsection{Struktur Data Big Integer} \label{sec:bignum_struct}
  \subsubsection{Struktur BIGNUM}

    Pada OpenSSL, sebuah big integer direpresentasikan dalam struktur data |BIGNUM|. |BIGNUM| terdiri dari sebuah array dengan ukuran dinamis dan beberapa variabel integer yang menyimpan informasi tambahan. Dengan demikian secara teori |BIGNUM| tidak memiliki nilai maksimum. Untuk keperluan paralelisasi, |BIGNUM| dapat digunakan tanpa mengubah strukturnya sedikitpun. BIGNUM sendiri merupakan sebuah \textit{struct} yang memiliki deklarasi sesuai pada Source Code \ref{code:bignum_st}.

    \begin{lstlisting}[caption={Struktur Data bignum}, label={code:bignum_st}]
struct bignum_st {
       BN_ULONG *d;
       int top;
       int dmax;
       int neg;
       int flags;
};
    \end{lstlisting}

    |BN_ULONG| sendiri adalah sebuah makro yang menggantikan |unsigned long|.

    |d| adalah pointer untuk array of integer.

    |top| merupakan index |d| yang terakhir digunakan plus satu.

    |dmax| adalah panjang maksimum array yang telah dibuat. |neg| bernilai satu jika BIGNUM bernilai negatif.

    \subsubsection{Struktur BN\_CTX}

    Setiap kali pembuatan struktur data |BIGNUM| terjadi alokasi memori yang memiliki overhead yang cukup tinggi jika dilakukan berulang ulang \citep{doc_bnctx}. Sementara itu, operasi aritmatika kompleks seperti perkalian dengan algoritma karatsuba, pembagian, atau perpangkatan modulo membutuhkan beberapa struktur |BIGNUM| yang digunakan untuk menyimpan variabel sementara. Struktur data |BN_CTX| menyimpan sejumlah variabel |BIGNUM| yang dapat digunakan dalam operasi aritmatika, dengan demikian program tidak pelu melakukan alokasi memori setiap kali program membutuhkan sebuah struktur |BIGNUM|.

    % jelasin lebih jauh

    \begin{lstlisting}[caption={Struktur bignum\_ctx}, label={code:bignum_ctx}]
struct bignum_ctx {
    BN_POOL pool;
    BN_STACK stack;
    unsigned int used;
    int err_stack;
    int too_many;
    int flags;
};

/* BN_POOL */
typedef struct bignum_pool_item {
    BIGNUM vals[BN_CTX_POOL_SIZE];
    struct bignum_pool_item *prev, *next;
} BN_POOL_ITEM;
typedef struct bignum_pool {
    BN_POOL_ITEM *head, *current, *tail;
    unsigned used, size;
} BN_POOL;

/* BN_STACK */
typedef struct bignum_ctx_stack {
    unsigned int *indexes;
    unsigned int depth, size;
} BN_STACK;
    \end{lstlisting}

    Struktur dari |BN_CTX| dapat dilihat pada Source Code \ref{code:bignum_ctx}. |BN_CTX| terdiri dari kumpulan |BIGNUM| yang disimpan pada |BN_POOL| serta |BN_STACK| yang menyimpan jumlah |BIGNUM| yang digunakan oleh sebuah fungsi. |BN_POOL| merupakan list of array dengan panjang array sebesar |BN_CTX_POOL_SIZE|. |BN_STACK| digunakan untuk menyimpan jumlah BIGNUM yang digunakan dalam sebuah fungsi.

    Fungsi yang menggunakan |BN_CTX| harus memanggil |BN_CTX_start()| sebelum penggunaan |BN_CTX| dan memanggil |BN_CTX_end()| setelah pemanggilan |BN_CTX|. Dua fungsi tersebut akan menyimpan dan menghitung jumlah BIGNUM yang didapat dari pemanggilan |BN_CTX_get()| pada fungsi tersebut.

    \subsubsection{Struktur Data untuk Paralelisasi}
    Terdapat beberapa struktur data tambahan yang dibuat untuk paralelisasi fungsi menggunakan pthread. Pemanggilan fungsi oleh pthread membutuhkan sebuah fungsi yang menerima satu argumen dengan tipe |void *|. Agar fungsi yang dijalankan secara paralel dapat mengolah lebih dari satu data, dibuat \textit{struct} khusus untuk setiap fungsi tersebut. Struktur data yang dibuat untuk digunakan oleh fungsi paralel dapat dilihat pada \textit{Source Code} \ref{code:parallel_struct}.

    \begin{lstlisting}[caption={Struktur Data Paralelisasi}, label={code:parallel_struct}]
typedef struct _add_sub_args_st {
    BN_ULONG *r;
    const BN_ULONG *a;
    const BN_ULONG *b;
    int n;
    int id;
    char type;
    BN_ULONG carry;
} add_sub_args;

typedef struct _mul_normal_args_st {
    BN_ULONG *r;
    const BN_ULONG *a;
    BN_ULONG w;
    int n;
    BN_ULONG carry;
} mul_normal_args;

typedef struct _recursive_args_st {
    BN_ULONG *r;
    BN_ULONG *a;
    BN_ULONG *b;
    int n2;
    int dna;
    int dnb;
    BN_ULONG *t;
    int *used_thr;
} recursive_args;
    \end{lstlisting}

  \subsection{Implementasi Modul Operasi Aritmatika}

    \input{chapters/body-matter/ch-4/bn_impl/bn_impl_add.tex}
    \input{chapters/body-matter/ch-4/bn_impl/bn_impl_mul.tex}
    \input{chapters/body-matter/ch-4/bn_impl/bn_impl_div.tex}
    \input{chapters/body-matter/ch-4/bn_impl/bn_impl_asm.tex}
